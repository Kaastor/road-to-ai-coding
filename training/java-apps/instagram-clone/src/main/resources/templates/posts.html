<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts - Instagram Clone</title>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
</head>
<body>
    <div class="nav">
        <a href="/">Home</a>
        <a href="/register">Register</a>
        <a href="/login">Login</a>
        <a href="/posts" class="active">Posts</a>
        <a href="/api-docs">API Docs</a>
    </div>
    
    <div id="loginRequired" class="container login-required" style="display: none;">
        <h1>Authentication Required</h1>
        <p>You need to be logged in to create and view posts.</p>
        <p><a href="/login">Click here to login</a> or <a href="/register">register a new account</a></p>
    </div>

    <div id="mainContainer" style="display: none;">
        <div class="container">
            <div id="userInfo" class="user-info">
                <div class="user-details">
                    Welcome, <span id="currentUsername"></span>!
                </div>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>

            <div class="create-post">
                <h2>Create New Post</h2>
                <form id="createPostForm">
                    <div class="form-group">
                        <label for="postContent">What's on your mind?</label>
                        <textarea id="postContent" name="content" placeholder="Share your thoughts..." required></textarea>
                    </div>
                    <button type="submit" id="submitBtn">Share Post</button>
                </form>
                <div id="createMessage"></div>
            </div>

            <div class="posts-section">
                <h2>My Posts</h2>
                <div id="loadingPosts" class="loading">Loading posts...</div>
                <div id="postsContainer"></div>
                <div id="noPosts" class="no-posts" style="display: none;">
                    You haven't created any posts yet. Share your first post above!
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = localStorage.getItem('sessionId');
        let currentUser = null;
        
        // Check authentication on page load
        if (currentSessionId) {
            checkAuthAndLoadPosts();
        } else {
            showLoginRequired();
        }
        
        // Create post form submission
        document.getElementById('createPostForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const content = document.getElementById('postContent').value.trim();
            const messageDiv = document.getElementById('createMessage');
            const submitBtn = document.getElementById('submitBtn');
            
            if (!content) {
                messageDiv.innerHTML = '<div class="error">Post content cannot be empty.</div>';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sharing...';
            
            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Session-Id': currentSessionId
                    },
                    body: JSON.stringify({ content })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.innerHTML = '<div class="success">Post created successfully!</div>';
                    document.getElementById('createPostForm').reset();
                    loadMyPosts(); // Reload posts
                } else {
                    if (response.status === 401) {
                        handleAuthFailure();
                    } else {
                        messageDiv.innerHTML = '<div class="error">' + (data.error || 'Failed to create post') + '</div>';
                    }
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error">Network error. Please try again.</div>';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Share Post';
            }
        });
        
        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await fetch('/api/users/logout', {
                    method: 'POST',
                    headers: {
                        'Session-Id': currentSessionId
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('sessionId');
            currentSessionId = null;
            currentUser = null;
            window.location.href = '/login';
        });
        
        async function checkAuthAndLoadPosts() {
            try {
                const response = await fetch('/api/users/me', {
                    headers: {
                        'Session-Id': currentSessionId
                    }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('currentUsername').textContent = currentUser.username;
                    document.getElementById('mainContainer').style.display = 'block';
                    loadMyPosts();
                } else {
                    handleAuthFailure();
                }
            } catch (error) {
                handleAuthFailure();
            }
        }
        
        async function loadMyPosts() {
            const loadingDiv = document.getElementById('loadingPosts');
            const postsDiv = document.getElementById('postsContainer');
            const noPostsDiv = document.getElementById('noPosts');
            
            loadingDiv.style.display = 'block';
            postsDiv.innerHTML = '';
            noPostsDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/posts/my', {
                    headers: {
                        'Session-Id': currentSessionId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    loadingDiv.style.display = 'none';
                    
                    if (data.posts && data.posts.length > 0) {
                        data.posts.forEach(post => {
                            const postElement = createPostElement(post);
                            postsDiv.appendChild(postElement);
                        });
                    } else {
                        noPostsDiv.style.display = 'block';
                    }
                } else {
                    if (response.status === 401) {
                        handleAuthFailure();
                    } else {
                        loadingDiv.innerHTML = '<div class="error">Failed to load posts.</div>';
                    }
                }
            } catch (error) {
                loadingDiv.innerHTML = '<div class="error">Network error while loading posts.</div>';
            }
        }
        
        function createPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post-card';
            
            const createdAt = new Date(post.createdAt).toLocaleString();
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <span class="post-author">${currentUser.username}</span>
                    <span class="post-date">${createdAt}</span>
                </div>
                <div class="post-content">${escapeHtml(post.content)}</div>
            `;
            
            return postDiv;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function handleAuthFailure() {
            localStorage.removeItem('sessionId');
            currentSessionId = null;
            currentUser = null;
            showLoginRequired();
        }
        
        function showLoginRequired() {
            document.getElementById('loginRequired').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
        }
    </script>
</body>
</html>